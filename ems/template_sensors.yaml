# template_sensors.yaml
#
# EMS “product sensors” derived from raw Modbus registers.
# Key design:
# - Raw sensors are plumbing (excluded from recorder).
# - EMS sensors are stable/validated and suitable for dashboards + Energy.
# - Update cadence is controlled via triggers to reduce CPU/DB load.


  ##########################################################################
  # FAST EMS SENSORS (every 5 seconds): Power + Phase currents
  ##########################################################################
  - trigger:
      - platform: time_pattern
        seconds: "/5"
    sensor:
      # -----------------------------
      # EMS Grid Power (W)
      # -----------------------------
      - name: "EMS Grid Power"
        unique_id: ems_grid_power_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        variables:
          raw: "{{ states('sensor.sm_power_raw') | float(none) }}"
          sf:  "{{ states('sensor.sm_power_sf')  | int(none) }}"
          watts: >-
            {% if raw is none or sf is none %}
              {{ none }}
            {% else %}
              {{ raw * (10 ** sf) }}
            {% endif %}
          valid: >-
            {{ raw is not none
               and sf is not none
               and sf >= -4 and sf <= 0
               and watts is not none
               and (watts | abs) <= 40000 }}
        availability: "{{ valid }}"
        state: "{{ watts | round(0) }}"

      # -----------------------------
      # EMS PV Power (W)
      # -----------------------------
      - name: "EMS PV Power"
        unique_id: ems_pv_power_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        variables:
          raw: "{{ states('sensor.inv_pv_power_raw') | float(none) }}"
          sf:  "{{ states('sensor.inv_pv_power_sf')  | int(none) }}"
          watts: >-
            {% if raw is none or sf is none %}
              {{ none }}
            {% else %}
              {{ raw * (10 ** sf) }}
            {% endif %}
          valid: >-
            {{ raw is not none
               and sf is not none
               and sf >= -4 and sf <= 0
               and watts is not none
               and (watts | abs) <= 40000 }}
        availability: "{{ valid }}"
        state: "{{ watts | round(0) }}"

      # -----------------------------
      # EMS Battery Power (W)
      # Module 4 - Module 3 = Discharge - Charge = Net Battery Power
      # Positive = discharging, Negative = charging
      # -----------------------------
      - name: "EMS Battery Power"
        unique_id: ems_battery_power_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        availability: >
          {% set r3_state = states('sensor.gen24_storage_module3_dcw_raw') %}
          {% set r4_state = states('sensor.gen24_storage_module4_dcw_raw') %}
          {% set sf_state = states('sensor.gen24_dc_power_sf') %}
          {{ r3_state not in ['unavailable', 'unknown', 'none'] and
             r4_state not in ['unavailable', 'unknown', 'none'] and
             sf_state not in ['unavailable', 'unknown', 'none'] }}
        state: >
          {% set raw3 = states('sensor.gen24_storage_module3_dcw_raw') | int(0) %}
          {% set raw4 = states('sensor.gen24_storage_module4_dcw_raw') | int(0) %}
          {% set sf_raw = states('sensor.gen24_dc_power_sf') | int(-999) %}
          {% set sf = -2 if (sf_raw < -10 or sf_raw > 0) else sf_raw %}
          {% set power = (raw4 - raw3) * (10 ** sf) %}
          {{ [[-15000, power] | max, 15000] | min }}

      # -----------------------------
      # EMS Grid Phase Currents (A)
      # Clamp SF range and plausible amps range.
      # -----------------------------
      - name: "EMS Grid Current L1"
        unique_id: ems_grid_current_l1
        unit_of_measurement: "A"
        device_class: current
        state_class: measurement
        variables:
          raw: "{{ states('sensor.sm_current_l1_raw') | int(none) }}"
          sf:  "{{ states('sensor.sm_current_sf')     | int(none) }}"
          amps: >-
            {% if raw is none or sf is none %}
              {{ none }}
            {% else %}
              {{ raw * (10 ** sf) }}
            {% endif %}
          valid: >-
            {{ raw is not none
               and sf is not none
               and sf >= -4 and sf <= 0
               and amps is not none
               and (amps | abs) <= 40 }}
        availability: "{{ valid }}"
        state: "{{ amps | round(2) }}"

      - name: "EMS Grid Current L2"
        unique_id: ems_grid_current_l2
        unit_of_measurement: "A"
        device_class: current
        state_class: measurement
        variables:
          raw: "{{ states('sensor.sm_current_l2_raw') | int(none) }}"
          sf:  "{{ states('sensor.sm_current_sf')     | int(none) }}"
          amps: >-
            {% if raw is none or sf is none %}
              {{ none }}
            {% else %}
              {{ raw * (10 ** sf) }}
            {% endif %}
          valid: >-
            {{ raw is not none
               and sf is not none
               and sf >= -4 and sf <= 0
               and amps is not none
               and (amps | abs) <= 40 }}
        availability: "{{ valid }}"
        state: "{{ amps | round(2) }}"

      - name: "EMS Grid Current L3"
        unique_id: ems_grid_current_l3
        unit_of_measurement: "A"
        device_class: current
        state_class: measurement
        variables:
          raw: "{{ states('sensor.sm_current_l3_raw') | int(none) }}"
          sf:  "{{ states('sensor.sm_current_sf')     | int(none) }}"
          amps: >-
            {% if raw is none or sf is none %}
              {{ none }}
            {% else %}
              {{ raw * (10 ** sf) }}
            {% endif %}
          valid: >-
            {{ raw is not none
               and sf is not none
               and sf >= -4 and sf <= 0
               and amps is not none
               and (amps | abs) <= 40 }}
        availability: "{{ valid }}"
        state: "{{ amps | round(2) }}"


  ##########################################################################
  # SOC SENSORS (every 30 seconds): Battery SoC and reserve minimum
  ##########################################################################
  - trigger:
      - platform: time_pattern
        seconds: "/30"
    sensor:
      - name: "EMS Battery SoC"
        unique_id: ems_battery_soc
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        variables:
          v: "{{ states('sensor.gen24_battery_soc_raw') | int(none) }}"
          valid: "{{ v is not none and 0 <= v <= 10000 }}"
        availability: "{{ valid }}"
        state: >
          {% if not valid %}
            {{ none }}
          {% else %}
            {{ (v / 100) | round(1) }}
          {% endif %}

      - name: "EMS Battery SoC Minimum"
        unique_id: ems_battery_soc_min
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        variables:
          v: "{{ states('sensor.gen24_battery_soc_min_raw') | int(none) }}"
          valid: "{{ v is not none and 0 <= v <= 10000 }}"
        availability: "{{ valid }}"
        state: >
          {% if not valid %}
            {{ none }}
          {% else %}
            {{ (v / 100) | round(1) }}
          {% endif %}


  ##########################################################################
  # ENERGY TOTALS (every 60 seconds): Energy dashboard compatible sensors
  ##########################################################################
  - trigger:
      - platform: time_pattern
        seconds: "59"
    sensor:
      - name: "EMS Grid Import Energy Total"
        unique_id: ems_grid_import_energy_total_kwh
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        variables:
          raw: "{{ states('sensor.sm_totwhimp_raw') | float(none) }}"
          sf:  "{{ states('sensor.sm_totwhimp_sf')  | int(none) }}"
          wh: >-
            {% if raw is none or sf is none %}
              {{ none }}
            {% else %}
              {{ raw * (10 ** sf) }}
            {% endif %}
          valid: >-
            {{ raw is not none
               and sf is not none
               and sf >= -6 and sf <= 6
               and wh is not none
               and wh >= 0
               and wh < 1e12 }}
        availability: "{{ valid }}"
        state: >
          {% if not valid %}
            {{ none }}
          {% else %}
            {{ (wh / 1000) | round(3) }}
          {% endif %}

      - name: "EMS PV Energy Total"
        unique_id: ems_pv_energy_total_kwh
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        variables:
          wh: "{{ states('sensor.gen24_ac_lifetime_energy_raw') | float(none) }}"
          valid: "{{ wh is not none and wh >= 0 and wh < 1e12 }}"
        availability: "{{ valid }}"
        state: >
          {% if not valid %}
            {{ none }}
          {% else %}
            {{ (wh / 1000) | round(3) }}
          {% endif %}


  ##########################################################################
  # Binary sensors (updates when dependencies update; dependencies are 5s)
  ##########################################################################
  - binary_sensor:
      - name: "EMS Phase Sensors OK"
        unique_id: ems_phase_sensors_ok
        state: >
          {{ not (
               states('sensor.ems_grid_current_l1') in ['unavailable','unknown','none','']
            or states('sensor.ems_grid_current_l2') in ['unavailable','unknown','none','']
            or states('sensor.ems_grid_current_l3') in ['unavailable','unknown','none','']
          ) }}
